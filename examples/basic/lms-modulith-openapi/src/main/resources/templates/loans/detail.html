<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: layout(~{::content})}">
<body>
<th:block th:fragment="content">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">Dashboard</a></li>
            <li class="breadcrumb-item"><a th:href="@{/loans}">Loans</a></li>
            <li class="breadcrumb-item active" aria-current="page" th:text="'Loan #' + ${loan.id}">Loan #1</li>
        </ol>
    </nav>

    <!-- Alerts -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show mb-4" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <span th:text="${success}">Success message</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row">
        <!-- Loan Information -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-journal-text me-2"></i>Loan Details
                        <span class="badge ms-2"
                              th:classappend="${loan.status.name() == 'ACTIVE'} ? 'bg-primary' :
                                              (${loan.status.name() == 'RETURNED'} ? 'bg-success' :
                                              (${loan.status.name() == 'RETURNED_LATE'} ? 'bg-warning' : 'bg-danger'))"
                              th:text="${loan.status}">Status</span>
                    </h4>
                    <a th:href="@{/loans}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>Back to Loans
                    </a>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3 text-muted">Loan ID</div>
                        <div class="col-md-9">
                            <strong th:text="'#' + ${loan.id}">#1</strong>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 text-muted">Book ISBN</div>
                        <div class="col-md-9">
                            <code th:text="${loan.bookIsbn}">978-0-00-000000-0</code>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 text-muted">Member ID</div>
                        <div class="col-md-9">
                            <a th:href="@{/members/{id}(id=${loan.memberId})}"
                               class="text-info" th:text="'#' + ${loan.memberId}">#1</a>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 text-muted">Loan Date</div>
                        <div class="col-md-9" th:text="${#temporals.format(loan.loanDate, 'MMMM d, yyyy')}">January 1, 2024</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 text-muted">Due Date</div>
                        <div class="col-md-9">
                            <span th:text="${#temporals.format(loan.dueDate, 'MMMM d, yyyy')}">January 15, 2024</span>
                            <span class="badge bg-danger ms-2" th:if="${loan.overdue}">OVERDUE</span>
                        </div>
                    </div>
                    <div class="row mb-3" th:if="${loan.returnDate != null}">
                        <div class="col-md-3 text-muted">Return Date</div>
                        <div class="col-md-9" th:text="${#temporals.format(loan.returnDate, 'MMMM d, yyyy')}">January 14, 2024</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 text-muted">Renewals</div>
                        <div class="col-md-9" th:text="${loan.renewalCount} + ' / 2'">0 / 2</div>
                    </div>
                    <div class="row mb-3" th:if="${loan.notes != null && !loan.notes.isEmpty()}">
                        <div class="col-md-3 text-muted">Notes</div>
                        <div class="col-md-9" th:text="${loan.notes}">Notes</div>
                    </div>
                </div>
            </div>

            <!-- Fine Information -->
            <div class="card mb-4" th:if="${loan.fineAmount > 0}">
                <div class="card-header" th:classappend="${!loan.finePaid} ? 'bg-danger bg-opacity-10 border-danger' : 'bg-success bg-opacity-10 border-success'">
                    <h5 class="mb-0" th:classappend="${!loan.finePaid} ? 'text-danger' : 'text-success'">
                        <i class="bi bi-cash me-2"></i>Fine Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="mb-1 text-muted">Fine Amount</p>
                            <p class="fs-3 mb-0" th:classappend="${!loan.finePaid} ? 'text-danger' : 'text-success'"
                               th:text="'$' + ${#numbers.formatDecimal(loan.fineAmount, 1, 2)}">$5.00</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <span class="badge py-2 px-3 fs-6"
                                  th:classappend="${loan.finePaid} ? 'bg-success' : 'bg-danger'"
                                  th:text="${loan.finePaid} ? 'PAID' : 'UNPAID'">Status</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Card -->
            <div class="card" th:if="${!loan.returned}">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <form th:action="@{/loans/{id}/return(id=${loan.id})}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-box-arrow-in-left me-2"></i>Return Book
                            </button>
                        </form>
                        <form th:if="${!loan.overdue && loan.renewalCount < 2}"
                              th:action="@{/loans/{id}/renew(id=${loan.id})}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-outline-info btn-lg">
                                <i class="bi bi-arrow-repeat me-2"></i>Renew Loan
                            </button>
                        </form>
                    </div>
                    <div th:if="${loan.renewalCount >= 2}" class="mt-3 text-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Maximum renewals reached. Book must be returned.
                    </div>
                    <div th:if="${loan.overdue}" class="mt-3 text-danger">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        This loan is overdue. A fine will be applied upon return.
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Loan Status Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Status</h5>
                </div>
                <div class="card-body text-center">
                    <div class="display-6 mb-3">
                        <i th:classappend="${loan.status.name() == 'ACTIVE'} ? 'bi-hourglass-split text-primary' :
                                          (${loan.status.name() == 'RETURNED'} ? 'bi-check-circle text-success' :
                                          (${loan.status.name() == 'RETURNED_LATE'} ? 'bi-exclamation-circle text-warning' : 'bi-x-circle text-danger'))"
                           class="bi"></i>
                    </div>
                    <span class="badge fs-5 py-2 px-4"
                          th:classappend="${loan.status.name() == 'ACTIVE'} ? 'bg-primary' :
                                          (${loan.status.name() == 'RETURNED'} ? 'bg-success' :
                                          (${loan.status.name() == 'RETURNED_LATE'} ? 'bg-warning' : 'bg-danger'))"
                          th:text="${loan.status}">Status</span>

                    <div th:if="${loan.overdue && !loan.returned}" class="mt-3">
                        <span class="badge bg-danger py-2 px-3">
                            <i class="bi bi-clock me-1"></i>OVERDUE
                        </span>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex mb-3">
                        <div class="me-3">
                            <span class="badge bg-primary rounded-circle p-2">
                                <i class="bi bi-arrow-right"></i>
                            </span>
                        </div>
                        <div>
                            <p class="mb-0 small text-muted">Loaned</p>
                            <p class="mb-0" th:text="${#temporals.format(loan.loanDate, 'MMM d, yyyy')}">Date</p>
                        </div>
                    </div>
                    <div class="d-flex mb-3">
                        <div class="me-3">
                            <span class="badge rounded-circle p-2"
                                  th:classappend="${loan.overdue && !loan.returned} ? 'bg-danger' : 'bg-warning'">
                                <i class="bi bi-calendar"></i>
                            </span>
                        </div>
                        <div>
                            <p class="mb-0 small text-muted">Due Date</p>
                            <p class="mb-0" th:text="${#temporals.format(loan.dueDate, 'MMM d, yyyy')}">Date</p>
                        </div>
                    </div>
                    <div th:if="${loan.returnDate != null}" class="d-flex">
                        <div class="me-3">
                            <span class="badge bg-success rounded-circle p-2">
                                <i class="bi bi-check"></i>
                            </span>
                        </div>
                        <div>
                            <p class="mb-0 small text-muted">Returned</p>
                            <p class="mb-0" th:text="${#temporals.format(loan.returnDate, 'MMM d, yyyy')}">Date</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Links -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Quick Links</h5>
                </div>
                <div class="card-body d-grid gap-2">
                    <a th:href="@{/members/{id}(id=${loan.memberId})}" class="btn btn-outline-light">
                        <i class="bi bi-person me-2"></i>View Member
                    </a>
                    <a th:href="@{/loans/member/{id}(id=${loan.memberId})}" class="btn btn-outline-light">
                        <i class="bi bi-clock-history me-2"></i>Member's Loans
                    </a>
                    <a th:href="@{/loans}" class="btn btn-outline-light">
                        <i class="bi bi-list me-2"></i>All Loans
                    </a>
                </div>
            </div>
        </div>
    </div>
</th:block>
</body>
</html>
